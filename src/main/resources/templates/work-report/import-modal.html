<div th:fragment="import-modal">
    <div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="importModalLabel">
                        <i class="fa fa-file-import mr-2"></i> Import Work Report Data
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <form id="importForm" method="post" th:action="@{/work-reports/import}"
                        enctype="multipart/form-data">
                        <!-- Step 1: Upload File -->
                        <div class="step mb-4">
                            <h6><i class="fas fa-upload mr-1"></i> Step 1: Upload File</h6>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="importFile"
                                    accept=".csv,.tsv,.txt,.xlsx,.xls" required>
                                <label class="custom-file-label" for="importFile">Choose file (CSV, TSV, XLSX)</label>
                            </div>
                            <small class="form-text text-muted">
                                Supported formats: CSV, TSV (; separated), Excel (.xlsx, .xls)
                            </small>
                        </div>

                        <!-- Hidden fields to hold parsed data -->
                        <input type="hidden" id="importData" name="data" />
                        <input type="hidden" id="importSheet" name="sheet" />
                        <input type="hidden" id="importHeaderRow" name="headerRow" />

                        <!-- Step 2: Select Sheet -->
                        <div class="step mb-4" id="sheetSelection" style="display:none;">
                            <h6><i class="fas fa-table mr-1"></i> Step 2: Select Sheet</h6>
                            <select class="form-control" id="sheetSelect"></select>
                        </div>

                        <!-- Step 3: Map Columns -->
                        <div class="step mb-4" id="columnMapping" style="display:none;">
                            <h6><i class="fas fa-columns mr-1"></i> Step 3: Map Columns</h6>
                            <p class="text-muted mb-3">
                                Click to select/deselect columns. Detected header row: <strong id="headerRow">Row
                                    1</strong>
                            </p>
                            <div class="row border rounded p-3 bg-light" id="columnCheckboxes">
                                <!-- Buttons will be inserted here -->
                            </div>
                        </div>

                        <!-- Step 4: Preview -->
                        <div class="step" id="previewSection" style="display:none;">
                            <h6><i class="fas fa-eye mr-1"></i> Step 4: Preview Data</h6>
                            <div class="table-responsive mt-3">
                                <table id="item-table" class="display table table-striped table-hover">
                                    <thead class="bg-primary text-white">
                                        <tr></tr>
                                    </thead>
                                    <tbody id="previewTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-light" id="prevBtn" style="display:none;">Previous</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
                    <button type="button" class="btn btn-success" id="importBtn" style="display:none;">
                        <i class="fa fa-check mr-1"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Styles -->
    <style>
        .col-btn {
            padding: 8px 12px;
            margin: 4px;
            border: 2px solid #007bff;
            background-color: #e3f2fd;
            color: #0056b3;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.2s;
            user-select: none;
        }

        .col-btn.selected {
            background-color: #007bff;
            color: white;
            border-color: #005edc;
        }

        .col-btn:hover {
            opacity: 0.9;
        }

        #columnCheckboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        #item-table th,
        #item-table td {
            text-align: left;
            vertical-align: middle;
        }
    </style>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- Import Wizard Script -->
    <script src="/assets/js/import-wizard.js"></script>

    <!-- Initialize ImportWizard for Work Reports -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            new ImportWizard({
                likelyFields: [
                    "report date", "shift", "area", "equipment", "category", "problem",
                    "solution", "start time", "stop time", "technician", "supervisor",
                    "status", "work type", "remark", "total time", "scope"
                ],

                fieldMapping: {
                    // Excel Header → Backend DTO Field
                    "Report Date": "reportDate",
                    "Shift": "shift",
                    "Area": "area",
                    "Equipment": "equipment",
                    "Category": "category",
                    "Problem": "problem",
                    "Solution": "solution",
                    "Start Time": "startTime",
                    "Stop Time": "stopTime",
                    "Technician": "technician",
                    "Supervisor": "supervisor",
                    "Status": "status",
                    "Work Type": "workType",
                    "Remark": "remark",
                    "Total Time": "totalTime",
                    "Scope": "scope"
                },

                onError: (err) => {
                    alert("Import Error: " + err.message);
                }

                // Optional: Add onSuccess, onBeforeImport, etc.
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Export to Excel (Current Table Data)
            document.getElementById('exportExcel').addEventListener('click', function (e) {
                e.preventDefault();

                const table = document.getElementById('work-report-table');
                const headers = [
                    "Report Date",
                    "Shift",
                    "Area Name",
                    "Area Code",
                    "Equipment Name",
                    "Equipment Code",
                    "Category",
                    "Problem",
                    "Solution",
                    "Start Time",
                    "Stop Time",
                    "Total Time (min)",
                    "Technician Names",
                    "Technician Employee IDs",
                    "Supervisor",
                    "Status",
                    "Scope",
                    "Work Type",
                    "Remark"
                ];

                const data = [];
                document.querySelectorAll('#work-report-table tbody tr').forEach(tr => {
                    if (tr.style.display === 'none') return; // Skip filtered rows

                    const tds = tr.querySelectorAll('td');
                    let colIndex = 0;
                    const row = [];

                    // Report Date
                    row.push(tds[colIndex++].textContent.trim());

                    // Shift
                    row.push(tds[colIndex++].textContent.trim());

                    // ✅ Area Name & Code
                    const areaCell = tds[colIndex++];
                    const areaName = areaCell.textContent.trim();
                    const areaCode = areaCell.getAttribute('data-area-code') || '-';
                    row.push(areaName || '-');
                    row.push(areaCode);

                    // ✅ Equipment Name & Code
                    const equipmentCell = tds[colIndex++];
                    const equipmentName = equipmentCell.textContent.trim();
                    const equipmentCode = equipmentCell.getAttribute('data-equipment-code') || '-';
                    row.push(equipmentName || '-');
                    row.push(equipmentCode);

                    // Category
                    row.push(tds[colIndex++].textContent.trim());

                    // Problem
                    row.push(tds[colIndex++].textContent.trim());

                    // Solution
                    row.push(tds[colIndex++].textContent.trim());

                    // Start Time
                    row.push(tds[colIndex++].textContent.trim());

                    // Stop Time
                    row.push(tds[colIndex++].textContent.trim());

                    // Total Time (min)
                    row.push(tds[colIndex++].textContent.trim());

                    // ✅ Technician Names & Employee IDs
                    const techCell = tds[colIndex++];
                    const techNames = [];
                    const techEmpIds = [];

                    if (techCell.querySelector('.badge')) {
                        Array.from(techCell.querySelectorAll('.badge')).forEach(badge => {
                            const text = badge.textContent.trim(); // "Alex (EMP001)"
                            const match = text.match(/^(.+) \(([^)]+)\)$/);
                            if (match) {
                                techNames.push(match[1].trim());
                                techEmpIds.push(match[2].trim());
                            } else {
                                techNames.push(text); // fallback
                            }
                        });
                    }

                    row.push(techNames.join(", ") || '-');
                    row.push(techEmpIds.join(", ") || '-');

                    // Supervisor
                    row.push(tds[colIndex++].textContent.trim());

                    // Status
                    row.push(tds[colIndex++].textContent.trim());

                    // Scope
                    row.push(tds[colIndex++].textContent.trim());

                    // Work Type
                    row.push(tds[colIndex++].textContent.trim());

                    // Remark
                    row.push(tds[colIndex++].textContent.trim());

                    data.push(row);
                });

                // Create worksheet and workbook
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Work Reports");

                // Generate filename with date
                const dateStr = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, `Work_Report_Data_${dateStr}.xlsx`);
            });


            // Export to PDF (Current Table Data)
            document.getElementById('exportPdf').addEventListener('click', function (e) {
                e.preventDefault();

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Extract headers (skip "Action")
                const headers = [];
                document.querySelectorAll('#work-report-table thead th').forEach(th => {
                    const text = th.textContent.trim();
                    if (!text.includes('Action')) {
                        headers.push(text);
                    }
                });

                // Extract visible row data (skip "Action" column)
                const data = [];
                document.querySelectorAll('#work-report-table tbody tr').forEach(tr => {
                    if (tr.style.display === 'none') return;
                    const row = [];
                    const tds = tr.querySelectorAll('td');
                    for (let i = 0; i < tds.length - 1; i++) {
                        let cellText = tds[i].textContent.trim();

                        // For Technician(s), Supervisor: clean up badge formatting
                        if (tds[i].querySelector('.badge')) {
                            cellText = Array.from(tds[i].querySelectorAll('.badge'))
                                .map(b => b.textContent.trim())
                                .join(", ");
                        }

                        row.push(cellText);
                    }
                    data.push(row);
                });

                // Add title
                doc.setFontSize(16);
                doc.text("Work Report Data", 14, 15);

                // Generate table using autoTable
                doc.autoTable({
                    head: [headers],
                    body: data,
                    startY: 20,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    columnStyles: headers.reduce((acc, key, i) => {
                        acc[i] = { cellWidth: 'auto' };
                        return acc;
                    }, {})
                });

                // Save PDF
                const dateStr = new Date().toISOString().slice(0, 10);
                doc.save(`Work_Report_Data_${dateStr}.pdf`);
            });
        });
    </script>
</div>