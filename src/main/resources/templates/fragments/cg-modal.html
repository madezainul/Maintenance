<!-- Machine Type Modal -->
<div th:fragment="machine-type-modal">
    <div class="modal fade" id="addMachineTypeModal" tabindex="-1" role="dialog"
        aria-labelledby="addMachineTypeModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMachineTypeModalLabel">Add Machine Type</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/code-generator/save-machine-type}" method="post" id="addMachineTypeForm">
                        <div class="form-group">
                            <label for="machineTypeName">Name</label>
                            <input type="text" class="form-control" id="machineTypeName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="machineTypeCode">Code</label>
                            <input type="text" class="form-control" id="machineTypeCode" name="code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div th:fragment="category-modal">
    <div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addCategoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Add Category</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form th:object="${categoryDTO}" th:action="@{/code-generator/save-category}" method="post" id="addCategoryForm">
                        <div class="form-group">
                            <label for="categoryName">Name</label>
                            <input type="text" class="form-control" th:field="*{name}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">Name
                                is required.</div>
                        </div>
                        <div class="form-group">
                            <label for="categoryCode">Code</label>
                            <input type="text" class="form-control" th:field="*{code}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('code')}" th:errors="*{code}">Code
                                is required.</div>
                        </div>
                        <!-- <div class="form-group">
                            <label for="categoryMachineType">Machine Type</label>
                            <select class="form-control" id="categoryMachineType" th:field="*{machineType.code}" required>
                                <option value="">Select Machine Type</option>
                                <option th:each="machineType : ${machineTypes}" th:value="${machineType.code}"
                                    th:text="${machineType.name}"></option>
                            </select>
                        </div> -->
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Subcategory Modal -->
<div th:fragment="subcategory-modal">
    <div class="modal fade" id="addSubcategoryModal" tabindex="-1" role="dialog"
        aria-labelledby="addSubcategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSubcategoryModalLabel">Add Subcategory</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form th:object="${subcategoryDTO}" th:action="@{/code-generator/save-subcategory}" method="post" id="addSubcategoryForm">
                        <div class="form-group">
                            <label for="subcategoryName">Name</label>
                            <input type="text" class="form-control" th:field="*{name}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">Name
                                is required.</div>
                        </div>
                        <div class="form-group">
                            <label for="subcategoryCode">Code</label>
                            <input type="text" class="form-control" th:field="*{code}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('code')}" th:errors="*{code}">Code
                                is required.</div>
                        </div>
                        <!-- <div class="form-group">
                            <label for="subcategoryCategory">Category</label>
                            <select class="form-control" id="subcategoryCategory" th:field="*{category.code}" required>
                                <option value="">Select Category</option>
                                <option th:each="category : ${categories}" th:value="${category.code}"
                                    th:text="${category.name}"></option>
                            </select>
                        </div> -->
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Serial Number Modal -->
<div th:fragment="serial-number-modal">
    <div class="modal fade" id="addSerialNumberModal" tabindex="-1" role="dialog" aria-labelledby="addSerialNumberModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSerialNumberModalLabel">Add Serial Number</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form th:object="${serialNumberDTO}" th:action="@{/code-generator/save-serial-number}" method="post" id="addSerialNumberForm">
                        <div class="form-group">
                            <label for="serialNumberName">Name</label>
                            <input type="text" class="form-control" th:field="*{name}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">Name
                                is required.</div>
                        </div>
                        <div class="form-group">
                            <label for="serialNumberCode">Code</label>
                            <input type="text" class="form-control" th:field="*{code}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('code')}" th:errors="*{code}">Code
                                is required.</div>
                        </div>
                        <!-- <div class="form-group">
                            <label for="serialNumberSubcategory">Subcategory</label>
                            <select class="form-control" id="serialNumberSubcategory" th:field="*{subcategory.code}" required>
                                <option value="">Select Subcategory</option>
                                <option th:each="subcategory : ${subcategories}" th:value="${subcategory.code}"
                                    th:text="${subcategory.name}"></option>
                            </select>
                        </div> -->
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Supplier Modal -->
<div th:fragment="supplier-modal">
    <div class="modal fade" id="addSupplierModal" tabindex="-1" role="dialog" aria-labelledby="addSupplierModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSupplierModalLabel">Add Supplier</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form th:object="${supplierDTO}" th:action="@{/code-generator/save-supplier}" method="post" id="addSupplierForm">
                        <div class="form-group">
                            <label for="supplierName">Name</label>
                            <input type="text" class="form-control" id="supplierName" th:field="*{name}" required>
                        </div>
                        <div class="form-group">
                            <label for="supplierCode">Code</label>
                            <input type="text" class="form-control" id="supplierCode" th:field="*{code}" required>
                        </div>
                        <!-- <div class="form-group">
                            <label for="supplierSerialNumber">Serial Number</label>
                            <select class="form-control" id="supplierSerialNumber" th:field="*{serialNumber.code}" required>
                                <option value="">Select Serial Number</option>
                                <option th:each="serialNumber : ${serialNumbers}" th:value="${serialNumber.code}"
                                    th:text="${serialNumber.name}"></option>
                            </select>
                        </div> -->
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section Modal -->
<div th:fragment="section-modal">
    <div class="modal fade" id="addSectionModal" tabindex="-1" role="dialog" aria-labelledby="addSectionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSectionModalLabel">Add Section</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/code-generator/save-section}" method="post" id="addSectionForm">
                        <div class="form-group">
                            <label for="sectionCode">Code</label>
                            <input type="text" class="form-control" id="sectionCode" name="code" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="view-modal">
    <div class="modal fade" id="addViewModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Machine type</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Inside modal-body, before table -->
                    <div class="form-row mb-3 align-items-center">
                        <div class="col">
                            <input type="text" id="viewSearch" class="form-control form-control-sm"
                                placeholder="Search by code, name, or category..." />
                        </div>
                        <div class="col-auto">
                            <button type="button" id="searchBtn" class="btn btn-primary btn-sm">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    <!-- Search will be injected here -->
                    <div class="table-responsive">
                        <table class="display table table-striped table-hover" id="partSearchResults">
                            <thead class="bg-primary text-white">
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Pagination will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Delete -->
    <div class="modal fade" id="deleteRowModal" tabindex="-1" role="dialog" aria-labelledby="deleteRowModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white no-bd">
                    <h5 class="modal-title" id="deleteRowModalLabel">Delete Complaint</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-4">
                    <p>Are you sure you want to delete this complaint?</p>
                    <strong id="deleteDocName" class="text-dark"></strong>
                    <p class="text-muted mt-2 mb-0">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-border" data-dismiss="modal">Cancel</button>
                    <a href="#" id="confirmDeleteButton" class="btn btn-danger ml-2">Yes, Delete</a>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // === Global State ===
            let currentPage = 0;
            let currentSearch = '';
            const pageSize = 10;

            // === Add Machine Type to Main Table ===
            window.addMachineTypeToTable = function (machineType) {
                const tbody = document.getElementById('machineTypesTable').querySelector('tbody');
                const existing = tbody.querySelector(`tr[data-machine-type-code="${machineType.code}"]`);

                if (existing) {
                    const qtyCell = existing.querySelector('td:nth-child(4)');
                    const newQty = parseInt(qtyCell.getAttribute('data-original')) + 1;
                    qtyCell.setAttribute('data-original', newQty);
                    qtyCell.textContent = newQty;
                } else {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-machine-type-code', machineType.code);
                    tr.setAttribute('data-machineType-id', machineType.id); // 👈 STORE ID ON ROW
                    tr.innerHTML = `
                    <td><code class="bg-light px-2 py-1 rounded">${machineType.code}</code></td>
                    <td>${machineType.name}</td>
                    <td>${machineType.category}</td>
                    <td class="text-center font-weight-bold"
                        contenteditable="true"
                        data-original="1"
                        onclick="this.textContent = this.getAttribute('data-original'); this.focus();"
                        onblur="this.setAttribute('data-original', this.textContent.trim());">
                        1
                    </td>
                    <td class="text-center">
                        <button class="btn btn-link text-danger btn-sm delete-row" type="button">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>`;
                    tbody.appendChild(tr);

                    tr.querySelector('.delete-row').addEventListener('click', function () {
                        tr.remove();
                        updatePartsUsedData();
                    });
                }

                updatePartsUsedInputs();
                updatePartsUsedData();
            };

            // === Sync Table to Hidden Input ===
            function updatePartsUsedInputs() {
                const container = document.getElementById('partsUsedInputs');
                container.innerHTML = ''; // Clear existing

                const rows = document.querySelectorAll('#partsTable tbody tr');
                rows.forEach((row, index) => {
                    const code = row.querySelector('code').textContent.trim();
                    const name = row.querySelector('td:nth-child(2)').textContent.trim();
                    const category = row.querySelector('td:nth-child(3)').textContent.trim();
                    const qty = row.querySelector('td:nth-child(4)').getAttribute('data-original') || '1';
                    const id = row.getAttribute('data-part-id'); // Assumes you store ID on the row

                    // Helper to create hidden input
                    function addField(name, value) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = name;
                        input.value = value;
                        container.appendChild(input);
                    }

                    // Add all fields
                    addField(`partsUsed[${index}].part.code`, code);
                    addField(`partsUsed[${index}].part.name`, name);
                    addField(`partsUsed[${index}].part.category`, category);
                    addField(`partsUsed[${index}].part.id`, id); // 👈 ADD THIS LINE
                    addField(`partsUsed[${index}].quantity`, qty);
                });
            }

            function updatePartsUsedData() {
                const parts = [];
                document.querySelectorAll('#partsTable tbody tr').forEach(row => {
                    parts.push({
                        id: row.getAttribute('data-part-id'), // 👈 ADD THIS
                        code: row.querySelector('code').textContent,
                        name: row.querySelector('td:nth-child(2)').textContent,
                        category: row.querySelector('td:nth-child(3)').textContent,
                        qty: row.querySelector('td:nth-child(4)').getAttribute('data-original')
                    });
                });
                document.getElementById('partsUsedData').value = JSON.stringify(parts);
            }

            // === Load Parts from API ===
            function loadParts(search = '', page = 0) {
                const url = new URL('/api/parts', window.location.origin);
                url.searchParams.append('keyword', search);
                url.searchParams.append('page', page);
                url.searchParams.append('size', pageSize);
                url.searchParams.append('sortBy', 'name');
                url.searchParams.append('asc', 'true');

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        renderParts(data);
                        renderPagination(data, page);
                    })
                    .catch(err => {
                        console.error('Failed to load parts:', err);
                        const tbody = document.querySelector('#partSearchResults tbody');
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load parts.</td></tr>';
                        document.getElementById('partsPagination').innerHTML = '';
                    });
            }

            // === Render Parts Table ===
            function renderParts(data) {
                const tbody = document.querySelector('#partSearchResults tbody');
                tbody.innerHTML = '';

                if (data.content.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No parts found.</td></tr>';
                    return;
                }

                data.content.forEach(part => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                  <td><code>${part.code}</code></td>
                  <td>${part.name}</td>
                  <td><span class="badge badge-secondary">${part.category}</span></td>
                  <td class="text-center">${part.stockQuantity}</td>
                  <td class="text-center">
                      <a href="javascript:void(0)" class="btn btn-primary btn-sm add-from-modal"
                         data-id="${part.id}"
                         data-code="${part.code}"
                         data-name="${part.name}"
                         data-category="${part.category}">
                         Add
                      </a>
                  </td>
              `;
                    tbody.appendChild(tr);
                });

                // Attach Add listeners
                document.querySelectorAll('.add-from-modal').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const part = {
                            id: this.dataset.id,        // 👈 ADD THIS
                            code: this.dataset.code,
                            name: this.dataset.name,
                            category: this.dataset.category
                        };
                        addPartToTable(part);
                        $('#addPartModal').modal('hide');
                    });
                });
            }

            // === Render Pagination ===
            function renderPagination(data, currentPage) {
                const paginationContainer = document.getElementById('partsPagination');
                paginationContainer.innerHTML = ''; // Clear pagination buttons only

                // === Finding or Creating "Showing..." Container ===
                let showingDiv = document.getElementById('partsShowingInfo');

                if (!showingDiv) {
                    // Create it only once
                    showingDiv = document.createElement('div');
                    showingDiv.id = 'partsShowingInfo'; // 👈 Unique ID for reuse
                    showingDiv.className = 'text-muted mb-2';
                    paginationContainer.parentNode.insertBefore(showingDiv, paginationContainer);
                }

                // === Update Content (Never Re-create Element) ===
                const start = currentPage * pageSize + 1;
                const end = Math.min(start + pageSize - 1, data.totalElements);
                showingDiv.innerHTML = `
                Showing ${start}–${end} of ${data.totalElements} entries`;

                // === Pagination Buttons ===
                const ul = document.createElement('ul');
                ul.className = 'pagination mb-0 justify-content-end';

                // Previous Button
                const prevLi = document.createElement('li');
                prevLi.className = data.hasPrevious ? 'page-item' : 'page-item disabled';
                prevLi.innerHTML = '<a class="page-link" href="#">Prev</a>';
                prevLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (data.hasPrevious) loadParts(currentSearch, currentPage - 1);
                });
                ul.appendChild(prevLi);

                // First Page Button
                if (currentPage > 0) {
                    const firstLi = document.createElement('li');
                    firstLi.className = 'page-item';
                    firstLi.innerHTML = '<a class="page-link" href="#">1</a>';
                    firstLi.addEventListener('click', (e) => {
                        e.preventDefault();
                        loadParts(currentSearch, 0);
                    });
                    ul.appendChild(firstLi);
                }

                // Ellipsis before current page
                if (currentPage > 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    ul.appendChild(ellipsisLi);
                }

                // Current Page
                const currentLi = document.createElement('li');
                currentLi.className = 'page-item active';
                currentLi.innerHTML = `<span class="page-link">${currentPage + 1}</span>`;
                ul.appendChild(currentLi);

                // Ellipsis after current page
                if (currentPage < data.totalPages - 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    ul.appendChild(ellipsisLi);
                }

                // Last Page Button
                if (currentPage < data.totalPages - 1) {
                    const lastLi = document.createElement('li');
                    lastLi.className = 'page-item';
                    lastLi.innerHTML = `<a class="page-link" href="#">${data.totalPages}</a>`;
                    lastLi.addEventListener('click', (e) => {
                        e.preventDefault();
                        loadParts(currentSearch, data.totalPages - 1);
                    });
                    ul.appendChild(lastLi);
                }

                // Next Button
                const nextLi = document.createElement('li');
                nextLi.className = data.hasNext ? 'page-item' : 'page-item disabled';
                nextLi.innerHTML = '<a class="page-link" href="#">Next</a>';
                nextLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (data.hasNext) loadParts(currentSearch, currentPage + 1);
                });
                ul.appendChild(nextLi);

                paginationContainer.appendChild(ul);
            }

            // === Search Input ===
            const searchInput = document.getElementById('partSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    currentSearch = this.value.trim();
                    loadParts(currentSearch, 0); // Reset to page 0
                });
            }

            // === Load Parts When Modal Opens ===
            $('#addPartModal').on('shown.bs.modal', function () {
                const modalBody = document.querySelector('#addPartModal .modal-body');

                // Add search UI if not exists
                if (!document.getElementById('partSearch')) {
                    const searchDiv = document.createElement('div');
                    searchDiv.className = 'form-row mb-3 align-items-center';
                    searchDiv.innerHTML = `
            <div class="col">
                <input type="text" id="partSearch" class="form-control" 
                       placeholder="Search by code, name, or category..." />
            </div>
            <div class="col-auto">
                <button type="button" id="searchBtn" class="btn btn-primary btn-sm">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        `;
                    modalBody.insertBefore(searchDiv, modalBody.firstChild);
                }

                // Add pagination if not exists
                if (!document.getElementById('partsPagination')) {
                    const paginationNav = document.createElement('nav');
                    paginationNav.innerHTML = `
            <ul class="pagination justify-content-center" id="partsPagination"></ul>
        `;
                    modalBody.appendChild(paginationNav);
                }

                // Attach events (only once)
                const searchInput = document.getElementById('partSearch');
                const searchBtn = document.getElementById('searchBtn');

                // Prevent Enter from submitting
                searchInput.removeEventListener('keypress', handleKeyPress); // Avoid duplicates
                searchInput.addEventListener('keypress', handleKeyPress);

                // Search button
                searchBtn.removeEventListener('click', handleSearchClick);
                searchBtn.addEventListener('click', handleSearchClick);

                // Load initial data
                loadParts(currentSearch, currentPage);
            });

            // === Reusable Event Handlers ===
            function handleKeyPress(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('searchBtn').click();
                }
            }

            function handleSearchClick() {
                const searchInput = document.getElementById('partSearch');
                currentSearch = searchInput.value.trim();
                currentPage = 0;
                loadParts(currentSearch, currentPage);
            }
        });
    </script>
</div>